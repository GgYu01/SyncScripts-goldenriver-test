### **Bash脚本开发需求文档**

#### **功能要求**
1. **文件夹检测**：
    - 脚本运行时首先检测当前执行的目录是否为 `Proxy_clash`，若不是，则脚本应立即退出。此检测不应影响后续其他执行。

2. **二进制文件部署**：
   - **部署 `tailscaled`**：将 `Proxy_clash` 文件夹下的 `tailscaled` 二进制文件复制并部署到 `/usr/sbin/` 目录中。
   - **部署 `tailscale`**：将 `Proxy_clash` 文件夹下的 `tailscale` 二进制文件复制并部署到 `/usr/bin/` 目录中。

3. **配置文件部署**：
   - **部署 `tailscaled` 配置文件**：将 `Proxy_clash/systemd` 文件夹下的 `tailscaled.defaults` 文件重命名为 `tailscaled`，并部署到 `/etc/default/` 目录中。

4. **服务管理检测**：
   - **检测服务管理工具**：
     - 检查本机是否支持 `systemd`，若支持则配置 `systemd` 服务管理。
     - 若不支持 `systemd`，则切换为使用 `init.d` 管理服务，确保 `tailscaled` 服务自动随开机启动。
   - **预置配置文档**：
     - 脚本应预置 `systemd` 和 `init.d` 的配置文档，无需依赖本地存在的配置文件。
     - 根据检测到的服务管理工具，选择并部署相应的配置文档。

5. **进程控制**：
   - **单实例运行**：
     - 确保在任何时刻只运行一个 `tailscaled` 进程，防止多个进程同时执行。
     - 若检测到已有 `tailscaled` 进程运行，应终止新进程启动，并提示用户手动重启服务。

6. **服务管理与启动**：
   - **配置文件生成与部署**：
     - 根据系统检测结果，生成相应的 `systemd` 或 `init.d` 配置文件，并自动放置到正确的服务路径。
   - **权限修改与服务启动**：
     - 修改相关文件和目录的权限，确保服务能够正常运行。
     - 启动 `tailscaled` 服务，启动日志和错误日志均需保存在 `Proxy_clash` 目录下。

7. **日志管理**：
   - **日志记录**：
     - 所有执行步骤均需记录日志，日志文件保存路径为当前脚本执行的目录 `Proxy_clash`。
     - 日志应包括操作成功、失败的详细信息，并使用时间戳标识。

8. **配置文件模板**：
   - **`systemd` 配置模板**：
     - 使用官方提供的 `tailscaled` `systemd` 示例配置文档作为模板。
     - 示例配置：
       ```ini
       [Unit]
       Description=Tailscale node agent
       Documentation=https://tailscale.com/kb/
       Wants=network-pre.target
       After=network-pre.target NetworkManager.service systemd-resolved.service

       [Service]
       EnvironmentFile=/etc/default/tailscaled
       ExecStart=/usr/sbin/tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=${PORT} $FLAGS
       ExecStopPost=/usr/sbin/tailscaled --cleanup

       Restart=on-failure

       RuntimeDirectory=tailscale
       RuntimeDirectoryMode=0755
       StateDirectory=tailscale
       StateDirectoryMode=0700
       CacheDirectory=tailscale
       CacheDirectoryMode=0750
       Type=notify

       [Install]
       WantedBy=multi-user.target
       ```
   - **`init.d` 配置模板**：
     - 参考上述 `systemd` 服务配置，确保 `init.d` 配置文件在功能上保持一致。

#### **交付内容**

- 完整的Bash脚本文件，具备上述所有功能要求。
- `systemd` 和 `init.d` 的配置文件模板，内嵌在脚本中，供自动部署使用。
- 使用说明文档，简要说明脚本的使用方法和注意事项。

#### **注意事项**
- 确保脚本具有足够的权限执行文件复制和服务配置操作，通常以普通用户运行脚本，请对脚本中需要root权限的命令额外添加sudo，用户会在执行脚本时完成sudo授权。
- 在修改系统文件和服务配置前，建议备份原有配置，以防止意外错误。
- 脚本应包含错误处理机制，确保在任何步骤失败时能够输出有用的错误信息并安全退出。
- 保证在不同的系统环境下的兼容性，特别是 `systemd` 和 `init.d` 的差异。

### **Bash脚本代码设计与规范**

#### **1. 模块化设计**
- **全局变量定义**：在脚本开头定义全局变量，用于统一管理文件路径、编译命令、日志输出等。这些全局变量应具有易读的命名，以便用户能够快速定位和修改参数。通过全局变量集中管理，便于在不同环境中部署脚本时进行定制。

- **函数化封装**：将常用功能和逻辑封装为独立的函数，例如日志记录、错误处理、目录创建等。函数的封装可以提高代码的复用性，减少重复代码，并使逻辑结构更为清晰。每个函数应具备单一职责，尽量避免函数过于复杂，保持代码简洁且易于维护。

- **模块化逻辑**：将脚本的核心功能划分为若干模块，每个模块由独立的函数或函数集实现，以增强脚本的可维护性和可扩展性。确保每个模块可以单独测试和调试，便于发现和修复问题。

#### **2. 代码整洁与规范**
- **注释规范**：在每个函数和主要逻辑块前添加详细英文注释，说明其功能、输入参数、返回值及其用途。注释应简明扼要但信息充分，以便其他开发人员快速理解代码逻辑。

- **代码格式与排版**：保持代码风格一致，适当使用空行分隔逻辑块，以增强代码的可读性。代码缩进应统一，建议使用四个空格作为缩进单位，确保代码层次结构清晰。

- **命名规范**：使用有意义的变量名、函数名和常量名，避免使用缩写或不易理解的名称。命名应体现变量或函数的实际用途，使代码自解释性更强。

#### **3. 错误处理与进度监控**
- **统一的错误处理机制**：定义一个统一的错误处理函数，以确保在执行过程中遇到错误时能够及时捕获并处理，给出明确的错误提示信息。错误处理函数应包括错误日志记录和退出代码的设置，确保脚本在异常情况下的稳定性。

- **进度监控与日志记录**：通过日志文件记录每个步骤的执行状态，便于后续问题排查。日志记录应包括时间戳、模块名称和执行状态等信息，以便详细追踪脚本的执行过程。对于长时间运行的任务，可以考虑动态输出执行进度，帮助用户了解当前的执行状态。

#### **4. 日志输出与终端输出规范**
- **日志输出级别**：为日志输出定义不同的日志级别，例如：
  - **INFO**：用于记录正常的操作和流程信息。
  - **WARNING**：用于记录可能需要注意但不影响程序继续执行的情况。
  - **ERROR**：用于记录严重错误，通常意味着程序需要中断。
  - **DEBUG**：用于记录调试信息，帮助开发人员定位问题。

- **日志颜色说明**：在终端输出中使用颜色来区分不同的日志级别，以提高可读性：
  - **INFO**：绿色，表示操作成功或正常的信息。
  - **WARNING**：黄色，表示警告，需要用户关注。
  - **ERROR**：红色，表示错误，需要用户采取行动。
  - **DEBUG**：蓝色，表示调试信息，通常用于开发人员。

- **日志格式**：日志输出应包含时间戳、日志级别、模块名称和具体信息。例如：
  ```
  [2024-10-10 14:23:01] [INFO] [ModuleName] 操作成功完成。
  [2024-10-10 14:23:02] [ERROR] [ModuleName] 操作失败，错误原因：...
  ```

- **终端输出与日志结合**：重要的信息应同时输出到终端和日志文件中，帮助用户及时了解脚本的执行状态。同时，日志文件中应保存所有输出，便于日后追踪和问题排查。

#### **5. 减少代码重复**
- **函数复用与抽象**：将重复的逻辑抽取为通用函数，避免代码冗余。例如，目录创建、日志记录、错误处理等常见操作应统一封装为函数，以提高代码的复用性和可维护性。

- **参数化设计**：对于具有相似功能的操作，使用参数化设计以减少代码重复。通过传递不同的参数来控制函数的行为，使得同一个函数可以在不同场景下复用，增强代码的灵活性。

#### **6. 界面与输出需求**
- **日志输出规范**：为每个模块的执行创建独立的日志文件，详细记录执行信息，包括开始时间、结束时间、执行命令、错误信息等。日志输出应易于阅读，方便调试和追踪问题。

- **用户提示与进度显示**：对于需要用户等待的长时间操作，应提供明确的进度提示或进度条，帮助用户了解脚本的执行情况。对于可能失败的操作，应在失败时给出详细的错误信息和可能的解决办法。

#### **7. 执行与维护**
- **灵活性与可配置性**：通过全局变量和数组管理脚本中的模块和命令，使得脚本可以灵活地添加、删除或修改模块。确保脚本中的配置项集中管理，方便用户根据具体需求进行调整。

- **可维护性**：采用模块化设计、统一的错误处理机制和日志记录方式，使脚本易于维护。对于新增功能，应尽量遵循已有的代码结构和风格，确保整体代码的一致性和可读性。

- **用户友好性**：为了方便不熟悉计算机的用户使用，应在脚本中加入必要的用户提示，并提供默认参数值，使用户在不了解详细实现的情况下也能顺利运行脚本。同时，确保脚本具有良好的容错性，避免因用户输入错误导致脚本崩溃。

